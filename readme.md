# JavaScript Deobfuscator

A Python-based static analysis tool for deobfuscating JavaScript code that uses string table obfuscation with resolver functions and array rotation.

## ⚠️ Security Warning

**This tool is for security research, malware analysis, and educational purposes only.**

- **Never run obfuscated code without reviewing it first** - it may contain malware
- **Always use in an isolated/sandboxed environment** (VM, container, etc.)
- **Obfuscated JavaScript often indicates malicious intent** - proceed with caution
- **Review all deobfuscated output before execution** - even after deobfuscation, code may be harmful
- **The author is not responsible for misuse of this tool** or damage caused by analyzed code

If you're analyzing potentially malicious code:
- Use a disposable virtual machine
- Disconnect from networks
- Never use your primary system
- Consult with security professionals if unsure

## Overview

This tool performs **static analysis only** (no code execution) to reverse a specific obfuscation pattern commonly generated by JavaScript obfuscators. It extracts string tables, calculates offsets, simulates array rotation, and replaces obfuscated function calls with their original string values.

## Supported Obfuscation Pattern

This tool is designed for JavaScript obfuscated with the following characteristics:

- **String table arrays** stored in functions (e.g., `function _0xcdde()`)
- **Resolver functions** that access strings by hex index (e.g., `_0x8c61(0x1a1)`)
- **Array rotation** via IIFE (Immediately Invoked Function Expression)
- **Hex offset calculations** (e.g., `idx = idx - 0x191`)
- **Hex-based variable naming** (e.g., `_0x8c61`, `*0x28f5eb`)

### Example Pattern

```javascript
function _0xcdde() {
    const _0x3bec45 = ['string1', 'string2', 'string3'];
    return _0x3bec45;
}

function _0x8c61(index) {
    const table = _0xcdde();
    return table[index - OFFSET];
}

(function(tableFunc, target) {
    const arr = tableFunc();
    while (true) {
        const calc = /* arithmetic */;
        if (calc === target) break;
        arr.push(arr.shift());  // Rotate
    }
}(_0xcdde, 123456));

// Obfuscated code
const myVar = _0x8c61(0x1a1);  // Replaced with actual string
```

## Important Limitations

This tool **ONLY** works for the specific pattern described above. It will **NOT** work for:

- Control flow flattening
- VM-based obfuscation (custom bytecode)
- Webpack/Rollup bundles
- Google Closure Compiler output
- Packer-based compression (eval chains)
- Other obfuscation tools with different patterns
- Multiple nested string tables
- Custom encoding schemes

**This is not a universal deobfuscator.** It targets one specific obfuscation technique.

## Installation

### Prerequisites
- Python 3.7 or higher
- No external dependencies (uses standard library only)

### Setup

```bash
git clone https://github.com/anubhavmohandas/deobfusticated-js.git
cd deobfusticated-js
python3 js_deobfuscator.py --help
```

## Usage

### Basic Usage

```bash
python3 js_deobfuscator.py obfuscated.js
```

This creates `obfuscated.js.deobf.js` with the deobfuscated code.

### Command-Line Options

```bash
python3 js_deobfuscator.py <input_file> [options]
```

| Option | Description |
|--------|-------------|
| `--out FILE`, `-o FILE` | Specify output file path (default: INPUT.deobf.js) |
| `--repeat` | Run multiple passes until no resolver calls remain |
| `--max-iter N` | Maximum iterations for repeat mode (default: 6) |
| `--collapse-concat` | Collapse adjacent string concatenations |
| `--mapping` | Print hex → string mapping table |
| `--preview` | Preview output without saving to file |
| `--help`, `-h` | Show help message and exit |

### Examples

**Full deobfuscation with all features:**
```bash
python3 js_deobfuscator.py input.js --repeat --collapse-concat --mapping --out clean.js
```

**Preview without saving:**
```bash
python3 js_deobfuscator.py input.js --preview
```

**Multiple passes with concatenation collapse:**
```bash
python3 js_deobfuscator.py input.js --repeat --max-iter 10 --collapse-concat
```

**Show mapping table for analysis:**
```bash
python3 js_deobfuscator.py input.js --mapping --preview
```

## How It Works

The deobfuscation process follows these steps:

1. **Syntax Fixing**: Removes invalid syntax like `*0x` prefixes (runs 10 passes)
2. **String Table Extraction**: Locates and extracts the string array with escape sequence decoding
3. **Offset Calculation**: Finds the index offset used in resolver calculations
4. **Rotation Detection**: Simulates IIFE array rotation to find correct string order
5. **Code Transformation**: Replaces all resolver calls with actual string literals
6. **Concatenation Collapse** (optional): Merges adjacent string literals

## Output Information

After running, the tool displays:

```
Processing: input.js

  Found string table with 44 entries
  Calculated offset: 401 (0x191)
  IIFE target value: 123456
  Applied 15 rotation(s)

============================================================
Completed 1 pass(es)
Syntax fixes: 23
Resolver calls: 47 → 0
Unique mappings: 44
============================================================

Output written to: input.js.deobf.js
```

## Troubleshooting

### "Could not find offset" Warning
**Cause**: The resolver function uses a non-standard pattern

**Solutions**:
- Try using `--repeat` flag for multiple passes
- Manually locate the offset calculation in the code
- Check if the obfuscation matches the supported pattern

### Gibberish Output (e.g., 'and: lio' instead of 'child_process')
**Cause**: Wrong array rotation applied or incorrect offset

**Solutions**:
- Use `--mapping` to see hex → string mappings
- Check if IIFE target value is calculated correctly
- Verify offset calculation matches the pattern

### Remaining `_0x...(0x...)` Calls
**Cause**: Index out of bounds or multiple string tables

**Solutions**:
- Use `--repeat` and increase `--max-iter`
- Check if code uses multiple string tables (not supported)
- Verify the string table was extracted completely

### Syntax Errors in Output
**Cause**: String escaping issues or incomplete transformation

**Solutions**:
- Use `--collapse-concat` carefully
- Validate output with a JavaScript linter
- Review the output manually for edge cases

## Technical Details

### Key Components

- **SyntaxFixer**: Removes asterisks and fixes invalid identifiers
- **StringTableExtractor**: Locates and parses string arrays with escape decoding
- **ResolverAnalyzer**: Finds offset calculations and IIFE patterns
- **RotationSolver**: Simulates array rotation to match IIFE target
- **CodeTransformer**: Replaces resolver calls with string literals

### Pattern Detection

The tool uses regex patterns to detect:
```python
# String table
r"(?:const|let|var)\s+(_0x[a-fA-F0-9_]+)\s*=\s*(\[[^\]]*\])"

# Resolver calls (both _0x and *0x)
r'(?:_0x|[*]0x)[a-fA-F0-9_]+\s*\(\s*(0x[0-9a-fA-F]+)\s*\)'

# Offset calculation
r"_0x[0-9a-fA-F_]+\s*=\s*_0x[0-9a-fA-F_]+\s*-\s*\(\s*([^)]+)\)"
```

## Example Transformation

**Before (obfuscated):**
```javascript
const cmd = _0x8c61(0x1a6) + _0x8c61(0x1af) + _0x8c61(0x1b8);
```

**After (deobfuscated):**
```javascript
const cmd = 'powershell' + ' -Command' + ' Invoke-WebRequest';
```

**With `--collapse-concat`:**
```javascript
const cmd = 'powershell -Command Invoke-WebRequest';
```

## Known Issues

1. Does not handle multiple string tables in a single file
2. Cannot deobfuscate dynamically computed indices
3. Requires valid JavaScript syntax as input
4. May struggle with heavily modified obfuscation patterns
5. No support for encrypted or encoded string tables

## Contributing

Contributions are welcome for:
- Additional pattern detection variants
- Better rotation algorithms
- Improved syntax fixing
- Bug fixes for edge cases
- Documentation improvements

**Note**: This tool is specifically designed for one obfuscation pattern. Major architectural changes to support completely different patterns may not be accepted.

## Use Cases

This tool is intended for:
- Security research and malware analysis
- Reverse engineering obfuscated JavaScript
- Educational purposes (learning about obfuscation techniques)
- Code audit and compliance verification
- CTF competitions and challenges

## License

MIT License - See LICENSE file for details

## Disclaimer

**READ THIS CAREFULLY:**

This tool is provided "as-is" for educational and security research purposes only. By using this tool, you acknowledge that:

1. You will only use it on code you have permission to analyze
2. You understand obfuscated code may be malicious
3. You will take proper security precautions (isolated environment, etc.)
4. The author is not responsible for any damage, data loss, or security incidents
5. You will comply with all applicable laws and regulations

**Malware Analysis Warning**: If analyzing suspected malware, follow proper security protocols and consult with experienced security professionals.

## Author

**Anubhav Mohan Das**

For security research and educational purposes only.

## Repository

https://github.com/anubhavmohandas/deobfusticated-js

---

**Remember**: Obfuscation often indicates malicious intent. Always analyze code in a safe, isolated environment and never run untrusted code on production systems.
